CREATE TABLE TIPO (
COD_TIPO INT NOT NULL  CONSTRAINT PK_COD_TIPO  PRIMARY KEY,
NOMBRE VARCHAR(50) NOT NULL,
)


CREATE TABLE TIPO_INFORMACION(
COD_TIPO__INFORMACION INT NOT NULL CONSTRAINT PK_CODTIPO_INFORMACION PRIMARY KEY,
NOMBRE VARCHAR(50) NOT NULL
)

CREATE TABLE FORMATO_MENSAJE(
COD_FORMATO INT NOT NULL CONSTRAINT PK_COD_FORMATO PRIMARY KEY,
COD_TIPO INT NOT NULL CONSTRAINT FK_TIPO FOREIGN KEY (COD_TIPO)REFERENCES TIPO(COD_TIPO),
COD_TIPO__INFORMACION INT NOT NULL CONSTRAINT FK_CODTIPO_INFORMACION FOREIGN KEY (COD_TIPO__INFORMACION) REFERENCES TIPO_INFORMACION(COD_TIPO__INFORMACION),
NOMBRE VARCHAR(50) NOT NULL,
REMITENTE VARCHAR(50) NOT NULL,
ASUNTO VARCHAR(50) NOT NULL,
)


CREATE TABLE PROYECTO(
PROYECTO INT NOT NULL CONSTRAINT PK_PROYECTO  PRIMARY KEY,
NOMBRE VARCHAR(50) NOT NULL,
)


CREATE TABLE PRODUCTO(
PRODUCTO INT NOT NULL CONSTRAINT PK_PRODUCTO PRIMARY KEY,
DESCRIPCION VARCHAR (100) NOT NULL,
)

CREATE TABLE PRODUCTO_PROYECTO(
PROYECTO INT NOT NULL,
PRODUCTO INT NOT NULL
CONSTRAINT PK_PROYECTO_PRODUCTO  PRIMARY KEY(PROYECTO,PRODUCTO),
CONSTRAINT FK_PROYECTO FOREIGN KEY (PROYECTO) REFERENCES PROYECTO(PROYECTO),
CONSTRAINT FK_PRODUCTO FOREIGN KEY (PRODUCTO) REFERENCES PRODUCTO(PRODUCTO)
)

CREATE TABLE MENSAJE(
COD_MENSAJE INT NOT NULL CONSTRAINT PK_COD_MENSAJE PRIMARY KEY,
COD_FORMATO INT NOT NULL CONSTRAINT FK_COD_FORMATO FOREIGN KEY (COD_FORMATO) REFERENCES FORMATO_MENSAJE(COD_FORMATO),
PROYECTO INT NOT NULL,
PRODUCTO INT NOT NULL,
CONSTRAINT FK_PROYECTO_PRODUCTO FOREIGN KEY (PROYECTO,PRODUCTO) REFERENCES PRODUCTO_PROYECTO (PROYECTO,PRODUCTO),
)


INSERT INTO PROYECTO (PROYECTO,NOMBRE) VALUES
(1,'Premia'),
(2,'Konmi'),
(3,'Yujule')


INSERT INTO PRODUCTO (PRODUCTO,DESCRIPCION) VALUES
(1,'Premia Clásica'),
(2,'Premia Oro'),
(3,'Premia Platinum')

INSERT INTO PRODUCTO_PROYECTO (PROYECTO,PRODUCTO) VALUES
(1,1),
(2,2),
(3,3)

INSERT INTO TIPO (COD_TIPO,NOMBRE) VALUES
(1,'Mensaje de texto'),
(2,'Mail'),
(3,'Mensaje en el estado decuenta')


INSERT INTO TIPO_INFORMACION(COD_TIPO__INFORMACION,NOMBRE) VALUES
(1,'Mensaje de bienvenida'),
(2,'Mensaje de Mora'),
(3,'Mensaje de Promoción')

INSERT INTO FORMATO_MENSAJE(COD_FORMATO,COD_TIPO,COD_TIPO__INFORMACION,NOMBRE,REMITENTE,ASUNTO) VALUES
(1,1,1,'JUAN FRANCISCO','MARCOS CONTRERAS', 'Mensaje de bienvenida'),
(2,2,2,'MARIA CANDELARIA','MARITZA ODILIA', 'Mensaje de Mora'),
(3,3,3,'ISMAEL ZALAZAR','ANDREZ PALA', 'Mensaje de Promoción')

INSERT INTO MENSAJE (COD_MENSAJE,COD_FORMATO,PROYECTO,PRODUCTO)
VALUES
(1,1,1,1),
(2,2,2,2),
(3,3,3,3)


--A. Escriba la consulta en SQL que devuelva el nombre del proyecto y sus productos
--correspondientes del proyecto premia cuyo código es 1

SELECT B.NOMBRE PROYECTO,C.DESCRIPCION PRODUCTO FROM PRODUCTO_PROYECTO A
INNER JOIN PROYECTO B ON A.PROYECTO=B.PROYECTO
INNER JOIN PRODUCTO C ON A.PRODUCTO=C.PRODUCTO
WHERE B.PROYECTO=1



--B. Escriba una consulta SQL que devuelva los distintos mensajes que hay, indicando a qué
--proyecto y producto pertenecen.

SELECT C.NOMBRE TIPO, D.NOMBRE TIPO_INFORMACION,F.NOMBRE PROYECTO,G.DESCRIPCION PRODUCTO FROM MENSAJE A
INNER JOIN FORMATO_MENSAJE B ON A.COD_FORMATO=B.COD_FORMATO
INNER JOIN TIPO C ON B.COD_TIPO=C.COD_TIPO 
INNER JOIN TIPO_INFORMACION D ON B.COD_TIPO__INFORMACION=D.COD_TIPO__INFORMACION
INNER JOIN PRODUCTO_PROYECTO E ON A.PROYECTO=E.PROYECTO AND A.PRODUCTO=E.PRODUCTO
INNER JOIN PROYECTO F ON E.PROYECTO=F.PROYECTO
INNER JOIN PRODUCTO G ON E.PRODUCTO=G.PRODUCTO


/*Escriba una consulta SQL que devuelva los distintos mensajes que hay, indicando a qué
proyecto y producto pertenecen.
Pero si el mensaje está en todos los productos de un
proyecto, en lugar de mostrar cada producto, debe mostrar el nombre del proyecto y un
solo producto que diga “TODOS”.*/


SELECT C.NOMBRE AS TIPO, D.NOMBRE AS TIPO_INFORMACION, 
       F.NOMBRE AS PROYECTO, 
       CASE 
            WHEN COUNT(DISTINCT A.PRODUCTO) = COUNT(DISTINCT E.PRODUCTO) THEN 'TODOS'
            ELSE G.DESCRIPCION 
       END AS PRODUCTO
FROM MENSAJE A
INNER JOIN FORMATO_MENSAJE B ON A.COD_FORMATO = B.COD_FORMATO
INNER JOIN TIPO C ON B.COD_TIPO = C.COD_TIPO 
INNER JOIN TIPO_INFORMACION D ON B.COD_TIPO__INFORMACION = D.COD_TIPO__INFORMACION
INNER JOIN PRODUCTO_PROYECTO E ON A.PROYECTO = E.PROYECTO AND A.PRODUCTO = E.PRODUCTO
INNER JOIN PROYECTO F ON E.PROYECTO = F.PROYECTO
INNER JOIN PRODUCTO G ON E.PRODUCTO = G.PRODUCTO 
GROUP BY C.NOMBRE, D.NOMBRE, F.NOMBRE, G.DESCRIPCION;
